{"ast":null,"code":"var https = require(\"https\");\n\nvar titlesURL = \".wiktionary.org/w/api.php?action=query&list=search&format=json&utf8&srprop=&srsearch=\";\nvar pagesURL = \".wiktionary.org/w/api.php?action=query&prop=revisions&rvprop=content&format=json&titles=\";\n\nvar parser = function (word, lng, options, callback) {\n  this.word = word;\n  this.lng = lng;\n  this.options = options || {};\n  this.callback = callback;\n  this.srwhat = \"nearmatch\";\n  this.lastTitle = \"\";\n  this.stripAccents = this.options.exact == false ? stripAccents : function (text) {\n    return text;\n  };\n};\n\nvar errors = {\n  notFound: \"not found\",\n  req: \"a request has failed\"\n};\n\nparser.prototype.sendErr = function (err, word) {\n  // console.log(\"ERR - word = \" +  (word || this.word) + \" - lng = \" + this.lng + \"\\n\" + err);\n  this.callback({\n    word: word || this.word,\n    err: err\n  });\n};\n\nparser.prototype.getTitles = function () {\n  var req = https.get(\"https://\" + this.lng + titlesURL + encodeURIComponent(this.word) + \"&srwhat=\" + this.srwhat, function (result) {\n    var cont = \"\";\n    result.on(\"data\", function (chunk) {\n      cont += chunk;\n    }).on(\"end\", function () {\n      try {\n        // par sécurité\n        var articles = JSON.parse(cont).query.search;\n      } catch (err) {\n        return this.sendErr(errors.req);\n      }\n\n      if (articles.length) {\n        var exclude = this.titles ? this.titles[0] : \"\";\n        this.titles = [];\n        var word2 = this.stripAccents(this.word.toLowerCase());\n        articles.forEach(function (article) {\n          var title = article.title;\n          if (title != exclude && this.stripAccents(title.toLowerCase()) == word2) this.titles.push(title);\n        }, this);\n        if (this.titles.length) this.getPage();else this.sendErr(errors.notFound);\n      } else {\n        if (this.srwhat == \"nearmatch\") {\n          this.srwhat = \"text\";\n          this.getTitles();\n        } else this.sendErr(errors.notFound);\n      }\n    }.bind(this));\n  }.bind(this));\n  req.on(\"error\", function () {\n    this.sendErr(errors.req);\n  }.bind(this));\n};\n\nparser.prototype.getPage = function () {\n  var req = https.get(\"https://\" + this.lng + pagesURL + encodeURIComponent(this.titles[0]), function (result) {\n    var cont = \"\";\n    result.on(\"data\", function (chunk) {\n      cont += chunk;\n    }).on(\"end\", function () {\n      try {\n        // par sécurité\n        var pages = JSON.parse(cont).query.pages;\n      } catch (err) {\n        return this.sendErr(errors.req);\n      }\n\n      if (!pages) return this.sendErr(\"getPage - page = null - cont = \" + cont);\n\n      if (pages[-1]) {\n        if (this.lastTitle) this.cleanup(this.lastTitle, this.cat.toLowerCase(), this.titles[0]);else this.sendErr(errors.notFound);\n      } else {\n        var page = pages[Object.keys(pages)[0]].revisions[0][\"*\"];\n        this.parse(page);\n      }\n    }.bind(this));\n  }.bind(this));\n  req.on(\"error\", function () {\n    this.sendErr(errors.req);\n  }.bind(this));\n};\n\nparser.prototype.parse = function (page) {\n  var autoRedir = /^#REDIRECT[^[]*\\[\\[([^\\]]+)\\]\\]\\s*$/i.exec(page);\n\n  if (autoRedir) {\n    this.titles[0] = autoRedir[1];\n    return this.getPage();\n  }\n\n  var def = this.searchDef(page);\n  if (def == true) return;\n\n  if (def) {\n    for (var i = 0, len = this.variants.length; i < len; i++) {\n      var found = this.variants[i].exec(def);\n\n      if (found) {\n        this.lastTitle = this.titles[0];\n        this.titles[0] = found[found.length - 1]; // console.log (this.word + \" : variant #\" + i + \" ==> \" + this.titles[0]);\n\n        this.getPage();\n        return;\n      }\n    }\n\n    this.cleanup(this.titles[0], this.cat.toLowerCase(), def);\n  } else {\n    delete this.cat;\n\n    if (this.srwhat == \"nearmatch\") {\n      this.srwhat = \"text\";\n      this.getTitles();\n    } else {\n      this.titles.shift();\n      if (this.titles.length) this.getPage();else this.sendErr(errors.notFound);\n    }\n  }\n};\n\nparser.prototype.cleanup = function (word, cat, def) {\n  def = def.replace(new RegExp(\"{{(([^}|]+)\\\\|)+\" + this.lng + \"}}\", \"g\"), \"($2)\");\n  def = def.replace(/{{[^}]*}}/g, \"\");\n  def = def.replace(/<(\\w+)>[^<]*<\\/\\1>/, \"\").trim();\n  if (/^\\s*\\.*$/.test(def)) return this.sendErr(errors.notFound, word);\n  def = def.replace(/'''([^']+)'''/g, this.options.formatted ? \"<span style='bold'>$1</span>\" : \"$1\");\n  def = def.replace(/''([^']+)''/g, this.options.formatted ? \"<span style='italic'>$1</span>\" : \"$1\");\n\n  switch (this.options.hyperlinks) {\n    case \"brackets\":\n      break;\n\n    case \"html\":\n      var url = \"https://\" + this.lng + \".wiktionary.org/wiki/\";\n      def = def.replace(/\\[\\[([^\\]|]+)(\\|)([^\\]]+)\\]\\]/g, \"<a href='\" + url + \"$1' target='_blank'>$3</a>\");\n      def = def.replace(/\\[\\[([^\\]]+)\\]\\]/g, \"<a href='\" + url + \"$1' target='_blank'>$1</a>\");\n      break;\n\n    case \"none\":\n    default:\n      def = def.replace(/\\[\\[([^\\]|]+\\|)*([^\\]]+)\\]\\]/g, \"$2\");\n  }\n\n  this.callback({\n    \"word\": word,\n    \"category\": cat.replace(/\\|.*/, \"\"),\n    \"definition\": def.trim()\n  });\n};\n\nfunction stripAccents(text) {\n  var replace = {\n    à: \"a\",\n    á: \"a\",\n    â: \"a\",\n    ã: \"a\",\n    ä: \"a\",\n    ç: \"c\",\n    è: \"e\",\n    é: \"e\",\n    ê: \"e\",\n    ë: \"e\",\n    ì: \"i\",\n    í: \"i\",\n    î: \"i\",\n    ï: \"i\",\n    ñ: \"n\",\n    ò: \"o\",\n    ó: \"o\",\n    ô: \"o\",\n    õ: \"o\",\n    ö: \"o\",\n    ù: \"u\",\n    ú: \"u\",\n    û: \"u\",\n    ü: \"u\",\n    ý: \"y\",\n    ÿ: \"y\"\n  };\n\n  for (var i = 0, len = text.length, res = \"\"; i < len; i++) res += replace[text[i]] || text[i];\n\n  return res;\n}\n\nmodule.exports.parser = parser;\nmodule.exports.stripAccents = stripAccents;","map":{"version":3,"sources":["C:/Users/deonm/Documents/UNI/React/random-word-gen/node_modules/word-definition/parser.js"],"names":["https","require","titlesURL","pagesURL","parser","word","lng","options","callback","srwhat","lastTitle","stripAccents","exact","text","errors","notFound","req","prototype","sendErr","err","getTitles","get","encodeURIComponent","result","cont","on","chunk","articles","JSON","parse","query","search","length","exclude","titles","word2","toLowerCase","forEach","article","title","push","getPage","bind","pages","cleanup","cat","page","Object","keys","revisions","autoRedir","exec","def","searchDef","i","len","variants","found","shift","replace","RegExp","trim","test","formatted","hyperlinks","url","à","á","â","ã","ä","ç","è","é","ê","ë","ì","í","î","ï","ñ","ò","ó","ô","õ","ö","ù","ú","û","ü","ý","ÿ","res","module","exports"],"mappings":"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","sourcesContent":["\r\nvar https = require(\"https\");\r\n\r\nvar titlesURL = \".wiktionary.org/w/api.php?action=query&list=search&format=json&utf8&srprop=&srsearch=\";\r\nvar pagesURL = \".wiktionary.org/w/api.php?action=query&prop=revisions&rvprop=content&format=json&titles=\";\r\n\r\nvar parser = function(word, lng, options, callback) {\r\n\r\n\tthis.word = word;\r\n\tthis.lng = lng;\r\n\tthis.options = options || {};\r\n\tthis.callback = callback;\r\n\tthis.srwhat = \"nearmatch\";\r\n\tthis.lastTitle = \"\";\r\n\r\n\tthis.stripAccents = this.options.exact == false ?  stripAccents : function(text) { return text; };\r\n\r\n}\r\n\r\nvar errors = {\r\n\tnotFound: \"not found\",\r\n\treq: \"a request has failed\"\r\n}\r\n\r\nparser.prototype.sendErr = function(err, word) {\r\n\r\n\t// console.log(\"ERR - word = \" +  (word || this.word) + \" - lng = \" + this.lng + \"\\n\" + err);\r\n\tthis.callback( { word: word || this.word, err: err });\r\n\r\n}\r\n\r\nparser.prototype.getTitles = function() {\r\n\r\n\tvar req = https.get(\"https://\" + this.lng + titlesURL + encodeURIComponent(this.word) + \"&srwhat=\" + this.srwhat, function(result) {\r\n\r\n\t\tvar cont = \"\";\r\n\r\n\t\tresult.on(\"data\", function(chunk) { cont += chunk; })\r\n\t\t.on(\"end\", function() {\r\n\t\t\ttry { // par sécurité\r\n\t\t\t\tvar articles = JSON.parse(cont).query.search;\r\n\t\t\t}\r\n\t\t\tcatch(err) {\r\n\t\t\t\treturn this.sendErr(errors.req);\r\n\t\t\t}\r\n\t\t\tif(articles.length) {\r\n\t\t\t\tvar exclude = this.titles ? this.titles[0] : \"\";\r\n\t\t\t\tthis.titles = [];\r\n\t\t\t\tvar word2 = this.stripAccents(this.word.toLowerCase());\r\n\t\t\t\tarticles.forEach(function(article) {\r\n\t\t\t\t\tvar title = article.title;\r\n\t\t\t\t\tif (title != exclude && this.stripAccents(title.toLowerCase()) == word2) this.titles.push(title);\r\n\t\t\t\t}, this);\r\n\t\t\t\tif (this.titles.length) this.getPage();\r\n\t\t\t\telse this.sendErr(errors.notFound);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif(this.srwhat == \"nearmatch\") {\r\n\t\t\t\t\tthis.srwhat = \"text\";\r\n\t\t\t\t\tthis.getTitles();\r\n\t\t\t\t}\r\n\t\t\t\telse this.sendErr(errors.notFound);\r\n\t\t\t}\r\n\t\t}.bind(this));\r\n\r\n\t}.bind(this));\r\n\r\n\treq.on(\"error\", function() { this.sendErr(errors.req); }.bind(this));\r\n\r\n}\r\n\r\nparser.prototype.getPage = function() {\r\n\r\n\tvar req = https.get(\"https://\" + this.lng + pagesURL + encodeURIComponent(this.titles[0]), function(result) {\r\n\t\tvar cont = \"\";\r\n\t\tresult.on(\"data\", function(chunk) { cont += chunk;\t})\r\n\t\t.on(\"end\", function() {\r\n\t\t\ttry { // par sécurité\r\n\t\t\t\tvar pages = JSON.parse(cont).query.pages;\r\n\t\t\t}\r\n\t\t\tcatch(err) {\r\n\t\t\t\treturn this.sendErr(errors.req);\r\n\t\t\t}\r\n\t\t\tif(!pages) return this.sendErr(\"getPage - page = null - cont = \" + cont);\r\n\t\t\tif(pages[-1]) {\r\n\t\t\t\tif(this.lastTitle) this.cleanup(this.lastTitle, this.cat.toLowerCase(), this.titles[0]);\r\n\t\t\t\telse this.sendErr(errors.notFound);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tvar page = pages[Object.keys(pages)[0]].revisions[0][\"*\"];\r\n\t\t\t\tthis.parse(page);\r\n\t\t\t}\r\n\t\t}.bind(this));\r\n\t}.bind(this));\r\n\r\n\treq.on(\"error\", function() { this.sendErr(errors.req); }.bind(this));\r\n\r\n}\r\n\r\nparser.prototype.parse = function(page) {\r\n\r\n\tvar autoRedir = /^#REDIRECT[^[]*\\[\\[([^\\]]+)\\]\\]\\s*$/i.exec(page);\r\n\tif(autoRedir) {\r\n\t\tthis.titles[0] = autoRedir[1];\r\n\t\treturn this.getPage();\r\n\t}\r\n\r\n\tvar def = this.searchDef(page);\r\n\r\n\tif (def == true) return;\r\n\r\n\tif (def) {\r\n\t\tfor(var i = 0, len = this.variants.length; i < len; i++) {\r\n\t\t\tvar found = this.variants[i].exec(def);\r\n\t\t\tif(found) {\r\n\t\t\t\tthis.lastTitle = this.titles[0];\r\n\t\t\t\tthis.titles[0] = found[found.length - 1];\r\n\t\t\t\t// console.log (this.word + \" : variant #\" + i + \" ==> \" + this.titles[0]);\r\n\t\t\t\tthis.getPage();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.cleanup(this.titles[0], this.cat.toLowerCase(), def);\r\n\t}\r\n\r\n\telse {\r\n\t\tdelete this.cat;\r\n\t\tif (this.srwhat == \"nearmatch\") {\r\n\t\t\tthis.srwhat = \"text\";\r\n\t\t\tthis.getTitles();\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.titles.shift();\r\n\t\t\tif(this.titles.length) this.getPage();\r\n\t\t\telse this.sendErr(errors.notFound); \r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nparser.prototype.cleanup = function(word, cat, def) {\r\n\r\n\tdef = def.replace(new RegExp(\"{{(([^}|]+)\\\\|)+\" + this.lng + \"}}\", \"g\"), \"($2)\");\r\n\tdef = def.replace(/{{[^}]*}}/g, \"\");\r\n\r\n\tdef = def.replace(/<(\\w+)>[^<]*<\\/\\1>/, \"\").trim();\r\n\r\n\tif(/^\\s*\\.*$/.test(def)) return this.sendErr(errors.notFound, word);\r\n\r\n\tdef = def.replace(/'''([^']+)'''/g, this.options.formatted ? \"<span style='bold'>$1</span>\" : \"$1\");\r\n\tdef = def.replace(/''([^']+)''/g, this.options.formatted ? \"<span style='italic'>$1</span>\" : \"$1\");\r\n\r\n\tswitch(this.options.hyperlinks) {\r\n\t\tcase \"brackets\":\r\n\t\t\tbreak;\r\n\t\tcase \"html\":\r\n\t\t\tvar url = \"https://\" + this.lng + \".wiktionary.org/wiki/\";\r\n\t\t\tdef = def.replace(/\\[\\[([^\\]|]+)(\\|)([^\\]]+)\\]\\]/g, \"<a href='\" + url + \"$1' target='_blank'>$3</a>\");\r\n\t\t\tdef = def.replace(/\\[\\[([^\\]]+)\\]\\]/g, \"<a href='\" + url + \"$1' target='_blank'>$1</a>\");\r\n\t\t\tbreak;\r\n\t\tcase \"none\":\r\n\t\tdefault:\r\n\t\t\tdef = def.replace(/\\[\\[([^\\]|]+\\|)*([^\\]]+)\\]\\]/g, \"$2\");\r\n\t}\r\n\r\n\tthis.callback({ \"word\": word, \"category\": cat.replace(/\\|.*/, \"\"), \"definition\": def.trim() });\r\n}\r\n\r\nfunction stripAccents(text) {\r\n\r\n\tvar replace = {\r\n\t\tà: \"a\", á: \"a\", â: \"a\", ã: \"a\", ä: \"a\",\r\n\t\tç: \"c\",\r\n\t\tè: \"e\", é: \"e\", ê: \"e\", ë: \"e\",\r\n\t\tì: \"i\", í: \"i\", î: \"i\", ï: \"i\",\r\n\t\tñ: \"n\",\r\n\t\tò: \"o\", ó: \"o\", ô: \"o\", õ: \"o\", ö: \"o\",\r\n\t\tù: \"u\", ú: \"u\", û: \"u\", ü: \"u\",\r\n\t\tý: \"y\", ÿ: \"y\"\r\n\t}\r\n\r\n\tfor (var i = 0, len = text.length, res = \"\"; i < len; i++) res += replace[text[i]] || text[i];\r\n\treturn res;\r\n\r\n}\r\n\r\nmodule.exports.parser = parser;\r\nmodule.exports.stripAccents = stripAccents;\r\n"]},"metadata":{},"sourceType":"script"}